{"version":3,"file":"index.js","sourceRoot":"","sources":["index.ts"],"names":[],"mappings":"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","sourcesContent":["import { Rule, SchematicContext, SchematicsException, Tree, chain } from '@angular-devkit/schematics';\r\nimport { experimental, JsonParseMode, parseJson } from '@angular-devkit/core';\r\nimport {\r\n    addPackageJsonDependency,\r\n    NodeDependency,\r\n    NodeDependencyType\r\n} from 'schematics-utilities';\r\n\r\nfunction addPackageJsonDependencies(): Rule {\r\n    return (host: Tree, context: SchematicContext) => {\r\n        const dependencies: NodeDependency[] = [\r\n            { type: NodeDependencyType.Default, version: '~2.0.0', name: '@netlify-builder/deploy' }\r\n        ];\r\n\r\n        dependencies.forEach(dependency => {\r\n            addPackageJsonDependency(host, dependency);\r\n            context.logger.log('info', `✅️ Added \"${dependency.name}\" into ${dependency.type}`);\r\n        });\r\n\r\n        return host;\r\n    };\r\n}\r\n\r\nfunction getWorkspace(host: Tree): { path: string; workspace: experimental.workspace.WorkspaceSchema } {\r\n    const possibleFiles = ['/angular.json', '/.angular.json'];\r\n    const path = possibleFiles.filter(path => host.exists(path))[0];\r\n\r\n    const configBuffer = host.read(path);\r\n    if (configBuffer === null) {\r\n        throw new SchematicsException(`Could not find angular.json`);\r\n    }\r\n    const content = configBuffer.toString();\r\n\r\n    let workspace: experimental.workspace.WorkspaceSchema;\r\n    try {\r\n        workspace = (parseJson(\r\n            content,\r\n            JsonParseMode.Loose\r\n        ) as {}) as experimental.workspace.WorkspaceSchema;\r\n    } catch (e) {\r\n        throw new SchematicsException(`Could not parse angular.json: ` + e.message);\r\n    }\r\n\r\n    return {\r\n        path,\r\n        workspace\r\n    };\r\n\r\n}\r\n\r\ninterface NgAddOptions {\r\n    project?: string;\r\n    siteID: string;\r\n    netlifyToken: string;\r\n}\r\n\r\nexport function netlifyBuilder(options: NgAddOptions): Rule {\r\n    return (tree: Tree, _context: SchematicContext) => {\r\n        // Verifying Angular.json\r\n        const { path: workspacePath, workspace } = getWorkspace(tree);\r\n\r\n        // getting project name\r\n        if (!options.project) {\r\n            if (workspace.defaultProject) {\r\n                options.project = workspace.defaultProject;\r\n            } else {\r\n                throw new SchematicsException(\r\n                    'No Angular project selected and no default project in the workspace'\r\n                );\r\n            }\r\n        }\r\n\r\n        // Validating project name\r\n        const project = workspace.projects[options.project];\r\n        if (!project) {\r\n            throw new SchematicsException(\r\n                'The specified Angular project is not defined in this workspace'\r\n            );\r\n        }\r\n\r\n        // Checking if it is application\r\n        if (project.projectType !== 'application') {\r\n            throw new SchematicsException(\r\n                `Deploy requires an Angular project type of \"application\" in angular.json`\r\n            );\r\n        }\r\n\r\n        // Getting output path from Angular.json\r\n        if (\r\n            !project.architect ||\r\n            !project.architect.build ||\r\n            !project.architect.build.options ||\r\n            !project.architect.build.options.outputPath\r\n        ) {\r\n            throw new SchematicsException(\r\n                `Cannot read the output path (architect.build.options.outputPath) of the Angular project \"${\r\n                options.project\r\n                }\" in angular.json`\r\n            );\r\n        }\r\n\r\n        // adding deploy statement for builder\r\n        project.architect['deploy'] = {\r\n            \"builder\": \"@netlify-builder/deploy:deploy\",\r\n            \"options\": {\r\n                \"outputPath\": project.architect.build.options.outputPath,\r\n                \"netlifyToken\": options.netlifyToken,\r\n                \"siteId\": options.siteID,\r\n            }\r\n        }\r\n        addPackageJsonDependencies();\r\n        tree.overwrite(workspacePath, JSON.stringify(workspace, null, 2));\r\n\r\n        return tree;\r\n\r\n    };\r\n}\r\n\r\nexport default function (options: NgAddOptions): Rule {\r\n    return chain(\r\n        [\r\n            netlifyBuilder(options),\r\n            addPackageJsonDependencies()\r\n        ]\r\n    )\r\n}"]}